#!/bin/bash

# Nodes according to the official list: https://protonvpn.com/vpn-servers#secure-core
# Secure Core Servers
CORE_SERVERS=(
  "CH-AT#2"
  "SE-EE#1"
  "CH-EE#2"
  "CH-LU#2"
  "IS-NO#1"
  "SE-NO#1"
  "CH-NO#2"
  "SE-FI#1"
  "CH-FI#2"
  "SE-RO#1"
  "CH-RO#2"
)

# Preferred Privacy-Friendly Countries (Standard Connection)
COUNTRIES=(
  "CH" # Switzerland
  "IS" # Iceland
  "NO" # Norway
  "SE" # Sweden
  "RO" # Romania
  "FI" # Finland
  "EE" # Estonia
  "LU" # Luxembourg
)

case "$1" in
  "-sc") # connect to random Secure Core server
    INDEX=$(( RANDOM % ${#CORE_SERVERS[@]} ))
    SELECTED="${CORE_SERVERS[$INDEX]}"
    echo "Selected Secure Core Server: $SELECTED"
    protonvpn connect "$SELECTED"
    ;;

  "-l") # list
    echo "--- Secure Core Servers ---"
    printf "%s\n" "${CORE_SERVERS[@]}"
    echo ""
    echo "--- Standard Servers ---"
    printf "%s\n" "${COUNTRIES[@]}"
    ;;

  "-d") # disconnect
    echo "Disconnecting from ProtonVPN..."
    protonvpn disconnect
    ;;

  "-s") # status
    echo "--- VPN Status ---"
    protonvpn info | sed -E "s/\{'name': '([^']+)'\}/Account: \1/"
    echo "Public IP: $(curl -s https://ifconfig.me)"
    echo "------------------"
    ;;

  "-m") # menu
    PS3="Select a Secure Core server number (or 'c' to cancel): "
    select s in "${CORE_SERVERS[@]}"; do
      if [[ "$REPLY" == "c" ]]; then
        echo "Connection attempt cancelled."
        exit 0
      elif [[ -n "$s" ]]; then
        echo "Connecting to $s..."
        protonvpn connect "$s"
        break
      else
        echo "Invalid option: $REPLY. Please choose a number from the list or 'c'."
      fi
    done
    ;;

  "-p") # privacy
    echo "Applying maximum privacy settings..."
    protonvpn config set anonymous-crash-reports off
    protonvpn config set ipv6 off
    protonvpn config set moderate-nat off
    protonvpn config set kill-switch standard
    protonvpn config set vpn-accelerator on
    protonvpn config set netshield malware-ads-trackers
    protonvpn config set custom-dns off
    echo "Privacy configuration applied."
    ;;

  "-h") # help
    echo "Usage: vpn [option]"
    echo "Options:"
    echo "  (none) Connect to a random standard server in preferred countries"
    echo "  -sc     Connect to a random Secure Core server"
    echo "  -d     Disconnect VPN"
    echo "  -l     List servers and countries"
    echo "  -s     Show connection status and IP"
    echo "  -m     Selection menu for Secure Core servers"
    echo "  -p     Apply maximum privacy settings"
    echo "  -h     Show help information for commands"
    ;;

  *)
    # Default: Connect to random Country
    INDEX=$(( RANDOM % ${#COUNTRIES[@]} ))
    SELECTED="${COUNTRIES[$INDEX]}"
    echo "Connecting to random server in: $SELECTED"
    protonvpn connect --country "$SELECTED"
    ;;
esac
